name: Build, Test & Release EOPFZarr Plugin

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
  release:
    types: [published]

permissions:
  contents: write
  actions: read
  checks: write

jobs:
  lint:
    name: Lint • cppcheck & clang-format
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - name: Install tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends cppcheck clang-format
      - name: cppcheck
        run: |
          cppcheck --enable=all --inconclusive --xml --xml-version=2 \
            src/ include/ 2> cppcheck-report.xml || true
      - name: Check code formatting
        run: |
          find src include -name "*.cpp" -o -name "*.h" | \
            xargs clang-format --style=file --dry-run --Werror || \
            (echo "Code formatting check failed. Please run 'clang-format -i' on your changes." && exit 1)
      - name: Upload cppcheck report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cppcheck-report
          path: cppcheck-report.xml
          retention-days: 7

  build_and_test:
    name: Build & Test • ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    needs: [lint]
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, windows-latest, macos-13]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Caching for Linux/macOS
      - if: runner.os != 'Windows'
        uses: hendrikmuhs/ccache-action@v1
        with:
          key: ${{ runner.os }}-${{ hashFiles('**/*.cpp','**/*.h') }}
          restore-keys: ${{ runner.os }}-

      # Platform-specific dependencies
      - name: Install deps (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            gdal-bin libgdal-dev cmake ninja-build build-essential

      - name: Install deps (macOS)
        if: runner.os == 'macOS'
        run: brew install gdal cmake ninja

      - name: Install deps (Windows)
        if: runner.os == 'Windows'
        uses: echoix/setup-OSGeo4W@v0.2.0
        with:
          packages: gdal-devel cmake ninja python3-pip python3-numpy
          root: C:\OSGeo4W

      - name: Setup MSVC (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      # Configure & Build
      - name: Configure & Build (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release
          cmake --build build --parallel

      - name: Configure & Build (Windows)
        if: runner.os == 'Windows'
        run: |
          cmake -S . -B build -G "Visual Studio 17 2022" -A x64 -DCMAKE_PREFIX_PATH="C:/OSGeo4W;C:/OSGeo4W/apps/gdal" -DGDAL_DIR="C:/OSGeo4W/apps/gdal/lib/cmake/gdal"
          cmake --build build --config Release --parallel

      # Testing
      - name: Unit Tests (C++)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          cd build
          ctest -C Release --output-on-failure

      - name: Unit Tests (C++) - Windows
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $env:GDAL_DRIVER_PATH = "$pwd\build\Release"
          $env:GDAL_DATA = "C:\OSGeo4W\share\gdal"
          $env:PATH = "C:\OSGeo4W\bin;" + $env:PATH
          cd build
          
          # Try to find ctest in common locations
          $ctestPaths = @(
            "C:\Program Files\CMake\bin\ctest.exe",
            "C:\Program Files (x86)\CMake\bin\ctest.exe",
            "C:\OSGeo4W\bin\ctest.exe",
            "ctest.exe"
          )
          
          $ctestFound = $false
          foreach ($ctestPath in $ctestPaths) {
            if (Test-Path $ctestPath -ErrorAction SilentlyContinue) {
              Write-Host "Using ctest from: $ctestPath"
              & $ctestPath -C Release --output-on-failure
              $ctestFound = $true
              break
            } elseif ($ctestPath -eq "ctest.exe") {
              try {
                & $ctestPath -C Release --output-on-failure
                $ctestFound = $true
                break
              } catch {
                # Continue to next option
              }
            }
          }
          
          if (-not $ctestFound) {
            Write-Host "ctest not found, trying alternative approach..."
            cmake --build . --config Release --target RUN_TESTS
          }

      - name: Integration Tests (Python) - Windows
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "# Set working directory explicitly"
          Set-Location $PWD
          
          Write-Host "Setting up environment variables..."
          $env:GDAL_DRIVER_PATH = "$PWD\build\Release"
          $env:GDAL_DATA = "C:\OSGeo4W\share\gdal"
          $env:PROJ_LIB = "C:\OSGeo4W\share\proj"
          $env:PATH = "C:\OSGeo4W\bin;C:\OSGeo4W\apps\Python39;C:\OSGeo4W\apps\Python39\Scripts;" + $env:PATH
          $env:PYTHONPATH = "C:\OSGeo4W\apps\Python39\Lib\site-packages"
          
          Write-Host "Verifying OSGeo4W Python installation..."
          $pythonPaths = @(
            "C:\OSGeo4W\apps\Python39\python.exe",    # Most common location
            "C:\OSGeo4W\bin\python.exe",              # Alternative location
            "C:\OSGeo4W\apps\Python310\python.exe",   # Python 3.10 variant
            "C:\OSGeo4W\apps\Python311\python.exe"    # Python 3.11 variant
          )
          
          $pythonExe = $null
          foreach ($path in $pythonPaths) {
            if (Test-Path $path -ErrorAction SilentlyContinue) {
              Write-Host "Found Python at: $path"
              $pythonExe = $path
              break
            } else {
              Write-Host "Python not found at: $path"
            }
          }
          
          if (-not $pythonExe) {
            Write-Host "ERROR: No Python executable found in OSGeo4W installation"
            Write-Host "Available files in C:\OSGeo4W\apps:"
            if (Test-Path "C:\OSGeo4W\apps" -ErrorAction SilentlyContinue) {
              Get-ChildItem "C:\OSGeo4W\apps" -ErrorAction SilentlyContinue | ForEach-Object { Write-Host " - $($_.Name)" }
            }
            Write-Host "Available files in C:\OSGeo4W\bin:"
            if (Test-Path "C:\OSGeo4W\bin" -ErrorAction SilentlyContinue) {
              Get-ChildItem "C:\OSGeo4W\bin" -Name "python*" -ErrorAction SilentlyContinue | ForEach-Object { Write-Host " - $_" }
            }
            exit 1
          }
          
          Write-Host "Testing Python version..."
          & $pythonExe --version
          if ($LASTEXITCODE -ne 0) {
            Write-Host "ERROR: Python version check failed"
            exit 1
          }
          
          Write-Host "Installing Python packages..."
          & $pythonExe -m pip install pytest numpy
          if ($LASTEXITCODE -ne 0) {
            Write-Host "ERROR: Failed to install Python packages"
            exit 1
          }
          
          Write-Host "Verifying package installation..."
          & $pythonExe -c "import pytest; import numpy; print('Packages imported successfully')"
          if ($LASTEXITCODE -ne 0) {
            Write-Host "ERROR: Failed to import installed packages"
            exit 1
          }
          
          Write-Host "Testing GDAL driver loading..."
          & $pythonExe -c "import os; os.environ['GDAL_DRIVER_PATH']='$PWD\\build\\Release'; from osgeo import gdal; print('GDAL imported successfully')"
          if ($LASTEXITCODE -ne 0) {
            Write-Host "WARNING: GDAL import test failed, but continuing with pytest"
          }
          
          Write-Host "Checking pytest configuration..."
          if (-not (Test-Path "pytest.ini" -ErrorAction SilentlyContinue)) {
            Write-Host "WARNING: pytest.ini not found in current directory"
            Write-Host "Current directory contents:"
            Get-ChildItem | ForEach-Object { Write-Host " - $($_.Name)" }
          }
          
          Write-Host "Running integration tests..."
          if (Test-Path "tests\integration" -ErrorAction SilentlyContinue) {
            & $pythonExe -m pytest tests\integration\ -v --tb=short
          } else {
            Write-Host "ERROR: Integration test directory not found"
            Write-Host "Available test directories:"
            if (Test-Path "tests" -ErrorAction SilentlyContinue) {
              Get-ChildItem "tests" | ForEach-Object { Write-Host " - tests\$($_.Name)" }
            } else {
              Write-Host "No tests directory found"
            }
            exit 1
          }

      - name: Integration Tests (Python) - Linux/macOS
        if: runner.os != 'Windows'
        shell: bash
        run: |
          # Set environment for tests
          export GDAL_DRIVER_PATH="$PWD/build"
          python -m pip install pytest numpy
          python -m pytest -c pytest.ini tests/integration/ -v --tb=short

      - name: Smoke test (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          export GDAL_DRIVER_PATH="$PWD/build"
          gdalinfo --formats | grep "EOPFZARR"

      - name: Smoke test (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $env:GDAL_DRIVER_PATH = "$pwd\build\Release"
          $env:GDAL_DATA = "C:\OSGeo4W\share\gdal"
          $env:PATH = "C:\OSGeo4W\bin;" + $env:PATH
          gdalinfo --formats | findstr "EOPFZARR"

      # Upload Artifacts
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: gdal_EOPFZarr-${{ runner.os }}
          path: |
            build/gdal_EOPFZarr.so
            build/gdal_EOPFZarr.dylib
            build/Release/gdal_EOPFZarr.dll
          if-no-files-found: ignore

  package-release:
    name: Package Release Artifacts
    runs-on: ubuntu-22.04
    needs: [build_and_test]
    if: github.event_name == 'release' && github.event.action == 'published'
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Display downloaded artifacts structure
        run: ls -R artifacts
      - name: Create Release Packages
        run: |
          mkdir -p release_packages
          for dir in artifacts/*; do
            if [ -d "$dir" ]; then
              PKG_NAME=$(basename "$dir")
              zip -r "release_packages/${PKG_NAME}.zip" "$dir"
              tar -czf "release_packages/${PKG_NAME}.tar.gz" -C "$dir" .
            fi
          done
      - name: Upload Release Assets
        uses: softprops/action-gh-release@v2
        with:
          files: release_packages/*
          generate_release_notes: true
          token: ${{ secrets.GITHUB_TOKEN }}